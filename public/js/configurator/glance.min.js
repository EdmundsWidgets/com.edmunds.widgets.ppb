!function(a){"use strict";var b={min:250,max:970,value:250},c=_.template(['<option value="<%= niceName %>"><%= name %></option>'].join("")),d=_.template(['<option value="<%= year %>"><%= year %></option>'].join("")),e=_.template(['<div class="spinner"><div class="spinner-1"><p>Please,<br>fill out all fields</p><div class="dots"><div class="dot-1"></div><div class="dot-2"></div><div class="dot-3"></div><div class="dot-4"></div><div class="dot-5"></div></div></div></div>'].join("")),f=Backbone.View.extend({events:{"click #widget-get":"onSubmit",reset:"onReset","valid #vehicle-api-key-control":"onVehicleApiKeyChange","valid #zip-code-control":"onZipCodeChange","change .makes":"onSelectMake","change .models":"onSelectModel","change .years":"onSelectYear","change #toggleAllTabs":"onToggleAllTabs",'change .list-group-tabs [type="checkbox"]':"onSelectTabs","keyup #vehicle-api-key-input":"onApplyApiKey","keyup #zip-code-input":"onApplyZipCode","keypress #zip-code-input":"zipCodeInputFilter","paste #zip-code-input":"zipCodeInputFilter",'click #vehicle-api-key-control [data-section="change"] .btn':"onChangeClickKey",'click #zip-code-control [data-section="change"] .btn':"onChangeClickZip"},initialize:function(){this.$width=this.$('[name="width"]'),this.$height=this.$('[name="height"]'),this.$widthSlider=this.$("#width_slider"),this.$makesList=this.$(".makes").attr("disabled","disabled"),this.$modelsList=this.$(".models").attr("disabled","disabled"),this.$yearsList=this.$(".years").attr("disabled","disabled"),this.$tabsList=this.$(".list-group-tabs"),this.$tooltipContainer=this.$(".tooltip-container"),this.$includedMakes=this.$('[name="includedMakes"]'),this.vehicleApiControl=this.$("#vehicle-api-key-control").inputGroupControl({tooltipTitle:"Please enter a valid API key",validate:this.vehicleApiKeyValidator}).data("inputGroupControl"),this.zipCodeControl=this.$("#zip-code-control").inputGroupControl({tooltipTitle:"Please enter a valid ZIP code",disabled:!0,validate:this.zipCodeValidator}).data("inputGroupControl"),this.zipCodeControl.disable(),this.$("#zip-code-control div[data-section=change] .btn").on("click",$.proxy(this.zipCodeReset,this)),this.$("#vehicle-api-key-control div[data-section=change] .btn").on("click",$.proxy(this.zipCodeReset,this)),this.widthSlider=this.createSlider(this.$widthSlider,b,_.bind(this.onWidthChange,this)),this.renderWidget=_.debounce(this.renderWidget,500)},$widgetPlaceholder:$("#widget-placeholder"),renderWidget:function(){return this.options=this.toJSON(),this.year&&"Select a Year"!==this.year&&this.make&&"Select a Make"!==this.make&&this.model&&"Select a Model"!==this.model&&a.tabsList&&0!==a.tabsList.length?(this.$widgetPlaceholder.find("#atglancewidget").remove(),this.$widgetPlaceholder.prepend('<div id="atglancewidget"></div>'),this.widget=EDM.createWidget({type:"glance",renderTo:"atglancewidget",style:{width:this.options.width.replace("px",""),height:this.options.height.replace("px","")},scripts:['/libs/requirejs/require.js" data-main="js/main.js'],options:{apiKey:window.parent.apiKey,make:window.parent.make,model:window.parent.model,year:window.parent.year,submodel:window.parent.submodel,zipCode:window.parent.zipCode,tabsList:window.parent.tabsList}}),this):void this.loading()},loading:function(){this.$widgetPlaceholder.find("#atglancewidget").remove(),this.$widgetPlaceholder.prepend('<div id="atglancewidget"></div>'),this.$widgetPlaceholder.find("#atglancewidget").html(e)},createSlider:function(a,b,c){return a.slider({range:"min",value:b.value,min:b.min,max:b.max,create:function(){$(this).find(".ui-slider-handle").tooltip({animation:!1,title:b.value+"px",trigger:"manual",placement:"bottom",container:a.find(".ui-slider-handle")}).tooltip("show")},slide:function(a,b){$(this).find(".ui-slider-handle .tooltip-inner").text(b.value+"px")},change:function(a,b){$(this).find(".ui-slider-handle .tooltip-inner").text(b.value+"px"),_.isFunction(c)&&c(b.value)}}).data("ui-slider")},onWidthChange:function(b){this.$width.val(b+"px"),this.$height.val(this.getWidgetHeight(b)+"px"),a.year&&(a.make=this.make,a.model=this.model,a.year=this.year,a.apiKey=this.vehicleApiKey,a.zipCode=this.zipCode,this.renderWidget())},getWidgetHeight:function(a){return 485>a?630:a>=485&&720>a?630:a>=720?530:void 0},onVehicleApiKeyChange:function(a,b){this.vehicleApiKey=b,this.zipCodeControl.enable(),this.$("#zip-code-input").focus(),this.zipCodeControl.options.apiKey=b,this.findMakes(),this.renderWidget()},onChangeClickKey:function(){this.vehicleApiKey=void 0},onChangeClickZip:function(){this.zipCode=void 0},onZipCodeChange:function(a,b){this.zipCode=b,this.vehicleApiKey&&(this.findMakes(),this.renderWidget())},vehicleApiKeyValidator:function(a){var b=new jQuery.Deferred;return a?(jQuery.ajax({url:"/api/keyvalidate",data:{api_key:a,service:"vehicle"},dataType:"json",context:this,success:function(c){b[c.valid===!0?"resolveWith":"rejectWith"](this,[a])},error:function(){b.rejectWith(this,[a])}}),b.promise()):(b.rejectWith(this,[a]),b.promise())},zipCodeInputFilter:function(a){var b=a.keyCode||a.which,c=String.fromCharCode(b),d=/[0-9]/;if(8!==b)return d.test(c)?void 0:(a.preventDefault(),!1)},zipCodeReset:function(){this.$makesList.html("<option>List of Makes</option>"),this.$modelsList.html("<option>List of Models</option>"),this.$yearsList.html("<option>List of Years</option>"),this.$makesList.attr("disabled","disabled"),this.$modelsList.attr("disabled","disabled"),this.$yearsList.attr("disabled","disabled"),this.year=null,this.make=null,this.model=null,this.submodel=null,this.renderWidget()},zipCodeValidator:function(a){var b=new jQuery.Deferred;return/^\d{5}$/.test(a)?(jQuery.ajax({url:"http://api.edmunds.com/v1/api/region/zip/validation/"+a,data:{api_key:this.options.apiKey},dataType:"jsonp",context:this,success:function(c){b["true"===c[a]?"resolveWith":"rejectWith"](this,[a])},error:function(){b.rejectWith(this,[a])}}),b.promise()):(b.rejectWith(this,[a]),b.promise())},onSelectMake:function(a){this.make=$(a.currentTarget).val(),"Select a Make"!==this.make?(this.models=null,this.years=null,this.model=null,this.year=null,this.models=_.where(this.makes,{niceName:this.make}),this.model=this.models[0].niceName,this.$makesList.removeClass("not-valid"),this.$modelsList.html("<option>Loading models...</option>"),this.renderModelList(this.models[0].models),this.$modelsList.removeAttr("disabled"),this.$yearsList.html("<option>List of Years</option>"),this.$yearsList.attr("disabled","disabled"),this.renderWidget()):(this.$makesList.addClass("not-valid"),this.$modelsList.html("<option>List of Models</option>"),this.$yearsList.html("<option>List of Years</option>"),this.$yearsList.css("borderColor","transperent").attr("disabled","disabled"),this.$modelsList.attr("disabled","disabled"),this.models=null,this.years=null,this.renderWidget()),this.$includedMakes.val(this.make)},onSelectModel:function(a){this.model=$(a.currentTarget).val(),"Select a Model"!==this.model?(this.year=null,this.$modelsList.removeClass("not-valid"),this.years=_.where(this.models[0].models,{niceName:this.model}),this.$yearsList.html("<option>Loading years...</option>"),this.renderYearList(this.years[0].years),this.$yearsList.removeAttr("disabled"),this.renderWidget()):(this.$modelsList.addClass("not-valid"),this.$yearsList.html("<option>List of Years</option>"),this.$yearsList.css("borderColor","transperent").attr("disabled","disabled"),this.years=null,this.renderWidget()),this.getSubmodelName(this.make,this.model)},onSelectYear:function(b){var c=[];this.year=$(b.currentTarget).val(),"Select a Year"!==this.year?(this.$yearsList.removeClass("not-valid"),this.$tabsList.find('[type="checkbox"]:checked').each(function(){c.push(this.value)}),null==this.tabsList&&(this.tabsList=c),a.make=this.make,a.model=this.model,a.submodel=this.submodel,a.year=this.year,a.tabsList=c,this.$yearsList.css("borderColor","transperent"),this.renderWidget()):(this.$yearsList.addClass("not-valid"),a.year=null,a.tabsList=null,this.tabsList=null,this.$widgetPlaceholder.find("#atglancewidget").html(e)),a.apiKey=this.vehicleApiKey,a.zipCode=this.zipCode},findMakes:function(){return this.vehicleApiKey&&this.zipCode?(this.resetMakes(),this.$makesList.html("<option>Loading makes...</option>"),jQuery.ajax({url:"http://api.edmunds.com/api/vehicle/v2/makes",data:{api_key:this.vehicleApiKey},dataType:"jsonp",context:this,success:function(a){this.makes=a.makes,this.renderMakesList(a.makes),this.$makesList.removeAttr("disabled").focus()},error:function(){}}),this):void 0},getSubmodelName:function(a,b){jQuery.ajax({url:"https://api.edmunds.com/api/vehicle/v2/"+a+"/"+b,data:{api_key:this.vehicleApiKey},dataType:"jsonp",context:this,success:function(a){this.submodel=a.years[0].styles[0].submodel.niceName},error:function(){}})},resetMakes:function(){return this.$makesList.html("<option>List of Makes</option>"),this.$includedMakes.val(""),this},renderMakesList:function(a){return this.$makesList.empty(),a.sort(function(a,b){return a.name>b.name?1:a.name<b.name?-1:0}),this.$makesList.html("<option>Select a Make</option>"),_.each(a,function(a){this.$makesList.append(c(a))},this),this.make=a[0].niceName,this},renderModelList:function(a){return this.$modelsList.empty(),a.sort(function(a,b){return a.name>b.name?1:a.name<b.name?-1:0}),this.$modelsList.html("<option>Select a Model</option>"),_.each(a,function(a){this.$modelsList.append(c(a))},this),this},renderYearList:function(a){return this.$yearsList.empty(),a.sort(function(a,b){return a.year<b.year?1:a.year>b.year?-1:0}),this.$yearsList.html("<option>Select a Year</option>"),_.each(a,function(a){this.$yearsList.append(d(a))},this),this},onApplyApiKey:function(a){13==a.keyCode&&$("#vehicle-api-key-apply").click()},onApplyZipCode:function(a){13==a.keyCode&&$("#zip-code-apply").click()},onToggleAllTabs:function(a){var b=a.target.checked,c=this.$tabsList.find("input[type=checkbox]");c.prop("checked",b),this.onSelectTabs()},onSelectTabs:function(){var b=[];this.$tooltipContainer.tooltip({title:"At least one tab should be selected",trigger:"manual"}),this.$tabsList.find('[type="checkbox"]:checked').each(function(){b.push(this.value)}),this.$tooltipContainer.tooltip(0===b.length?"show":"hide"),a.tabsList=b,b.length<5?this.$("#toggleAllTabs").attr("checked",!1):5==b.length&&this.$("#toggleAllTabs").prop("checked","checked"),this.renderWidget()},toJSON:function(){var a={};return _.each(this.$el.serializeArray(),function(b){a[b.name]=b.value}),a},onSubmit:function(a){var b=!0;a.preventDefault(),this.vehicleApiKey||(this.vehicleApiControl.$input.tooltip("show"),b=!1),this.zipCode||(this.zipCodeControl.$input.tooltip("show"),b=!1),this.make&&this.model&&this.year&&this.tabsList||(b=!1,this.$yearsList.css("borderColor","#b72f38")),b&&(console.log(this.toJSON()),$("#insert-js").html(this.getJavaScriptSnippet()),$("#widget-instructions").modal({backdrop:"static",show:!0}))},getJavaScriptSnippet:function(){_.templateSettings={interpolate:/\{\{(.+?)\}\}/g};var a=this.htmlEntities(['<script type="text/javascript" src="'+f.ORIGIN+'/loader-glance.js"></script>\n','<script type="text/javascript">\n'+$("#js-snippet-template").html()+"\n</script>"].join(""));return _.template(a,{widgetConfig:JSON.stringify(this.getWidgetConfig(),"",4)},!0)},htmlEntities:function(a){return String(a).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},getWidgetConfig:function(){return{type:"glance",renderTo:"atglancewidget",style:{width:this.options.width.replace("px",""),height:this.options.height.replace("px","")},scripts:['/libs/requirejs/require.js" data-main="'+f.ORIGIN+"/glance/js/main.js"],options:{apiKey:window.parent.apiKey,make:window.parent.make,model:window.parent.model,year:window.parent.year,submodel:window.parent.submodel,zipCode:window.parent.zipCode,tabsList:window.parent.tabsList}}},onReset:function(){this.resetMakes(),this.zipCodeControl.reset(),this.widthSlider.option(b),this.year=null,this.make=null,this.model=null,this.submodel=null,this.tabsList=["rating-tab","edmunds-says-tab","consumer-reviews-tab","tco-tab","photos-tab"],this.vehicleApiKey&&(this.zipCodeControl.enable(),this.$makesList.html("<option>List of Makes</option>").attr("disabled","disabled"),this.$modelsList.html("<option>List of Models</option>").attr("disabled","disabled"),this.$yearsList.html("<option>List of Years</option>").attr("disabled","disabled")),a.year&&(a.make=this.make,a.model=this.model,a.submodel=this.submodel,a.year=this.year,a.apiKey=this.vehicleApiKey,a.zipCode=this.zipCode,a.tabsList=this.tabsList,this.renderWidget()),this.widget=null,this.renderWidget()},reset:function(){return this.el.reset(),this}});a.AtGlanceConfigurator=f}(this);